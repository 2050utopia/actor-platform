//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/actor-ios/build/java/com/droidkit/actors/mailbox/ActorDispatcher.java
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "com/droidkit/actors/Actor.h"
#include "com/droidkit/actors/ActorContext.h"
#include "com/droidkit/actors/ActorRef.h"
#include "com/droidkit/actors/ActorScope.h"
#include "com/droidkit/actors/ActorSystem.h"
#include "com/droidkit/actors/ActorTime.h"
#include "com/droidkit/actors/CurrentActor.h"
#include "com/droidkit/actors/Props.h"
#include "com/droidkit/actors/debug/TraceInterface.h"
#include "com/droidkit/actors/dispatch/AbstractDispatcher.h"
#include "com/droidkit/actors/extensions/ActorExtension.h"
#include "com/droidkit/actors/mailbox/ActorDispatcher.h"
#include "com/droidkit/actors/mailbox/ActorEndpoint.h"
#include "com/droidkit/actors/mailbox/Envelope.h"
#include "com/droidkit/actors/mailbox/Mailbox.h"
#include "com/droidkit/actors/mailbox/MailboxesQueue.h"
#include "com/droidkit/actors/messages/DeadLetter.h"
#include "com/droidkit/actors/messages/Ping.h"
#include "com/droidkit/actors/messages/PoisonPill.h"
#include "com/droidkit/actors/messages/StartActor.h"
#include "java/lang/Exception.h"
#include "java/lang/RuntimeException.h"
#include "java/util/ArrayList.h"
#include "java/util/HashMap.h"
#include "java/util/UUID.h"

@interface ComDroidkitActorsMailboxActorDispatcher () {
 @public
  id LOCK_;
  JavaUtilHashMap *endpoints_;
  JavaUtilHashMap *scopes_;
  DAActorSystem *actorSystem_;
  NSString *name_;
  ComDroidkitActorsDispatchAbstractDispatcher *dispatcher_;
}
@end

J2OBJC_FIELD_SETTER(ComDroidkitActorsMailboxActorDispatcher, LOCK_, id)
J2OBJC_FIELD_SETTER(ComDroidkitActorsMailboxActorDispatcher, endpoints_, JavaUtilHashMap *)
J2OBJC_FIELD_SETTER(ComDroidkitActorsMailboxActorDispatcher, scopes_, JavaUtilHashMap *)
J2OBJC_FIELD_SETTER(ComDroidkitActorsMailboxActorDispatcher, actorSystem_, DAActorSystem *)
J2OBJC_FIELD_SETTER(ComDroidkitActorsMailboxActorDispatcher, name_, NSString *)
J2OBJC_FIELD_SETTER(ComDroidkitActorsMailboxActorDispatcher, dispatcher_, ComDroidkitActorsDispatchAbstractDispatcher *)

@implementation ComDroidkitActorsMailboxActorDispatcher

- (instancetype)initWithNSString:(NSString *)name
               withDAActorSystem:(DAActorSystem *)actorSystem {
  if (self = [super init]) {
    ComDroidkitActorsMailboxActorDispatcher_setAndConsume_LOCK_(self, [[NSObject alloc] init]);
    ComDroidkitActorsMailboxActorDispatcher_setAndConsume_endpoints_(self, [[JavaUtilHashMap alloc] init]);
    ComDroidkitActorsMailboxActorDispatcher_setAndConsume_scopes_(self, [[JavaUtilHashMap alloc] init]);
    ComDroidkitActorsMailboxActorDispatcher_set_name_(self, name);
    ComDroidkitActorsMailboxActorDispatcher_set_actorSystem_(self, actorSystem);
  }
  return self;
}

- (void)initDispatcherWithComDroidkitActorsDispatchAbstractDispatcher:(ComDroidkitActorsDispatchAbstractDispatcher *)dispatcher {
  if (self->dispatcher_ != nil) {
    @throw [[[JavaLangRuntimeException alloc] initWithNSString:@"Double dispatcher init"] autorelease];
  }
  ComDroidkitActorsMailboxActorDispatcher_set_dispatcher_(self, dispatcher);
}

- (DAActorRef *)referenceActorWithNSString:(NSString *)path
                               withDAProps:(DAProps *)props {
  @synchronized(LOCK_) {
    if ([((JavaUtilHashMap *) nil_chk(scopes_)) containsKeyWithId:path]) {
      return [((DAActorScope *) nil_chk([scopes_ getWithId:path])) getActorRef];
    }
    ComDroidkitActorsMailboxMailbox *mailbox = [((DAProps *) nil_chk(props)) createMailboxWithComDroidkitActorsMailboxMailboxesQueue:[((ComDroidkitActorsDispatchAbstractDispatcher *) nil_chk(dispatcher_)) getQueue]];
    ComDroidkitActorsMailboxActorEndpoint *endpoint = [((JavaUtilHashMap *) nil_chk(endpoints_)) getWithId:path];
    if (endpoint == nil) {
      endpoint = [[[ComDroidkitActorsMailboxActorEndpoint alloc] initWithNSString:path] autorelease];
      [endpoints_ putWithId:path withId:endpoint];
    }
    DAActorScope *scope = [[[DAActorScope alloc] initWithDAActorSystem:actorSystem_ withComDroidkitActorsMailboxMailbox:mailbox withComDroidkitActorsMailboxActorDispatcher:self withJavaUtilUUID:JavaUtilUUID_randomUUID() withNSString:path withDAProps:props withComDroidkitActorsMailboxActorEndpoint:endpoint] autorelease];
    [((ComDroidkitActorsMailboxActorEndpoint *) nil_chk(endpoint)) connectWithComDroidkitActorsMailboxMailbox:mailbox withDAActorScope:scope];
    [scopes_ putWithId:[scope getPath] withId:scope];
    [((DAActorRef *) nil_chk([scope getActorRef])) sendWithId:ComDroidkitActorsMessagesStartActor_get_INSTANCE_()];
    return [scope getActorRef];
  }
}

- (void)killGracefullyWithDAActorScope:(DAActorScope *)scope {
  for (id<ComDroidkitActorsExtensionsActorExtension> __strong e in nil_chk([((DAActor *) nil_chk([((DAActorScope *) nil_chk(scope)) getActor])) getExtensions])) {
    [((id<ComDroidkitActorsExtensionsActorExtension>) nil_chk(e)) postStop];
  }
  [((DAActor *) nil_chk([scope getActor])) postStop];
  [scope onActorDie];
  {
    IOSObjectArray *a__ = [((ComDroidkitActorsMailboxMailbox *) nil_chk([scope getMailbox])) allEnvelopes];
    ComDroidkitActorsMailboxEnvelope * const *b__ = ((IOSObjectArray *) nil_chk(a__))->buffer_;
    ComDroidkitActorsMailboxEnvelope * const *e__ = b__ + a__->size_;
    while (b__ < e__) {
      ComDroidkitActorsMailboxEnvelope *e = *b__++;
      if ([((ComDroidkitActorsMailboxEnvelope *) nil_chk(e)) getSender] != nil) {
        [((DAActorRef *) nil_chk([e getSender])) sendWithId:[[[ComDroidkitActorsMessagesDeadLetter alloc] initWithId:[e getMessage]] autorelease]];
      }
    }
  }
  [((ComDroidkitActorsMailboxMailbox *) nil_chk([scope getMailbox])) clear];
  @synchronized(LOCK_) {
    [((JavaUtilHashMap *) nil_chk(scopes_)) removeWithId:[scope getPath]];
    [((JavaUtilHashMap *) nil_chk(endpoints_)) removeWithId:[scope getPath]];
    [((ComDroidkitActorsMailboxMailboxesQueue *) nil_chk([((ComDroidkitActorsDispatchAbstractDispatcher *) nil_chk(dispatcher_)) getQueue])) disconnectMailboxWithComDroidkitActorsMailboxMailbox:[scope getMailbox]];
  }
}

- (void)sendMessageWithComDroidkitActorsMailboxActorEndpoint:(ComDroidkitActorsMailboxActorEndpoint *)endpoint
                                                      withId:(id)message
                                                    withLong:(jlong)time
                                              withDAActorRef:(DAActorRef *)sender {
  if ([((ComDroidkitActorsMailboxActorEndpoint *) nil_chk(endpoint)) isDisconnected]) {
    if (sender != nil) {
      if ([((DAActorSystem *) nil_chk(actorSystem_)) getTraceInterface] != nil) {
        [((id<ComDroidkitActorsDebugTraceInterface>) nil_chk([actorSystem_ getTraceInterface])) onDeadLetterWithDAActorRef:sender withId:message];
      }
      [sender sendWithId:[[[ComDroidkitActorsMessagesDeadLetter alloc] initWithId:message] autorelease]];
    }
  }
  else {
    [((ComDroidkitActorsMailboxMailbox *) nil_chk([endpoint getMailbox])) scheduleWithComDroidkitActorsMailboxEnvelope:[[[ComDroidkitActorsMailboxEnvelope alloc] initWithId:message withDAActorScope:[endpoint getScope] withComDroidkitActorsMailboxMailbox:[endpoint getMailbox] withDAActorRef:sender] autorelease] withLong:time];
  }
}

- (void)sendMessageOnceWithComDroidkitActorsMailboxActorEndpoint:(ComDroidkitActorsMailboxActorEndpoint *)endpoint
                                                          withId:(id)message
                                                        withLong:(jlong)time
                                                  withDAActorRef:(DAActorRef *)sender {
  if ([((ComDroidkitActorsMailboxActorEndpoint *) nil_chk(endpoint)) isDisconnected]) {
    if (sender != nil) {
      if ([((DAActorSystem *) nil_chk(actorSystem_)) getTraceInterface] != nil) {
        [((id<ComDroidkitActorsDebugTraceInterface>) nil_chk([actorSystem_ getTraceInterface])) onDeadLetterWithDAActorRef:sender withId:message];
      }
      [sender sendWithId:[[[ComDroidkitActorsMessagesDeadLetter alloc] initWithId:message] autorelease]];
    }
  }
  else {
    [((ComDroidkitActorsMailboxMailbox *) nil_chk([endpoint getMailbox])) scheduleOnceWithComDroidkitActorsMailboxEnvelope:[[[ComDroidkitActorsMailboxEnvelope alloc] initWithId:message withDAActorScope:[endpoint getScope] withComDroidkitActorsMailboxMailbox:[endpoint getMailbox] withDAActorRef:sender] autorelease] withLong:time];
  }
}

- (void)cancelSendWithComDroidkitActorsMailboxActorEndpoint:(ComDroidkitActorsMailboxActorEndpoint *)endpoint
                                                     withId:(id)message
                                             withDAActorRef:(DAActorRef *)sender {
  if (![((ComDroidkitActorsMailboxActorEndpoint *) nil_chk(endpoint)) isDisconnected]) {
    [((ComDroidkitActorsMailboxMailbox *) nil_chk([endpoint getMailbox])) unscheduleWithComDroidkitActorsMailboxEnvelope:[[[ComDroidkitActorsMailboxEnvelope alloc] initWithId:message withDAActorScope:[endpoint getScope] withComDroidkitActorsMailboxMailbox:[endpoint getMailbox] withDAActorRef:sender] autorelease]];
  }
}

- (NSString *)getName {
  return name_;
}

- (void)processEnvelopeWithComDroidkitActorsMailboxEnvelope:(ComDroidkitActorsMailboxEnvelope *)envelope {
  DAActorScope *scope = [((ComDroidkitActorsMailboxEnvelope *) nil_chk(envelope)) getScope];
  if ([((DAActorSystem *) nil_chk(actorSystem_)) getTraceInterface] != nil) {
    [((id<ComDroidkitActorsDebugTraceInterface>) nil_chk([actorSystem_ getTraceInterface])) onEnvelopeDeliveredWithComDroidkitActorsMailboxEnvelope:envelope];
  }
  jlong start = DAActorTime_currentTime();
  jboolean isDisconnected = NO;
  if ([((DAActorScope *) nil_chk(scope)) getActor] == nil) {
    if ([envelope getMessage] == ComDroidkitActorsMessagesPoisonPill_get_INSTANCE_()) {
      return;
    }
    @try {
      DAActor *actor = [((DAProps *) nil_chk([scope getProps])) create];
      DACurrentActor_setCurrentActorWithDAActor_(actor);
      [((DAActor *) nil_chk(actor)) initActorWithJavaUtilUUID:[scope getUuid] withNSString:[scope getPath] withDAActorContext:[[[DAActorContext alloc] initWithDAActorScope:scope] autorelease] withComDroidkitActorsMailboxMailbox:[scope getMailbox]];
      for (id<ComDroidkitActorsExtensionsActorExtension> __strong e in nil_chk([actor getExtensions])) {
        [((id<ComDroidkitActorsExtensionsActorExtension>) nil_chk(e)) preStart];
      }
      [actor preStart];
      [scope onActorCreatedWithDAActor:actor];
    }
    @catch (JavaLangException *e) {
      [((JavaLangException *) nil_chk(e)) printStackTrace];
      if ([envelope getSender] != nil) {
        [((DAActorRef *) nil_chk([envelope getSender])) sendWithId:[[[ComDroidkitActorsMessagesDeadLetter alloc] initWithId:@"Unable to create actor"] autorelease]];
      }
      return;
    }
  }
  @try {
    if ([envelope getMessage] == ComDroidkitActorsMessagesStartActor_get_INSTANCE_()) {
      return;
    }
    else if ([envelope getMessage] == ComDroidkitActorsMessagesPing_get_INSTANCE_()) {
      return;
    }
    else if ([envelope getMessage] == ComDroidkitActorsMessagesPoisonPill_get_INSTANCE_()) {
      isDisconnected = YES;
      for (id<ComDroidkitActorsExtensionsActorExtension> __strong e in nil_chk([((DAActor *) nil_chk([scope getActor])) getExtensions])) {
        [((id<ComDroidkitActorsExtensionsActorExtension>) nil_chk(e)) postStop];
      }
      [((DAActor *) nil_chk([scope getActor])) postStop];
      [scope onActorDie];
      {
        IOSObjectArray *a__ = [((ComDroidkitActorsMailboxMailbox *) nil_chk([scope getMailbox])) allEnvelopes];
        ComDroidkitActorsMailboxEnvelope * const *b__ = ((IOSObjectArray *) nil_chk(a__))->buffer_;
        ComDroidkitActorsMailboxEnvelope * const *e__ = b__ + a__->size_;
        while (b__ < e__) {
          ComDroidkitActorsMailboxEnvelope *e = *b__++;
          if ([((ComDroidkitActorsMailboxEnvelope *) nil_chk(e)) getSender] != nil) {
            [((DAActorRef *) nil_chk([e getSender])) sendWithId:[[[ComDroidkitActorsMessagesDeadLetter alloc] initWithId:[e getMessage]] autorelease]];
          }
        }
      }
      [((ComDroidkitActorsMailboxMailbox *) nil_chk([scope getMailbox])) clear];
      @synchronized(LOCK_) {
        [((JavaUtilHashMap *) nil_chk(scopes_)) removeWithId:[scope getPath]];
        [((JavaUtilHashMap *) nil_chk(endpoints_)) removeWithId:[scope getPath]];
        [((ComDroidkitActorsMailboxMailboxesQueue *) nil_chk([((ComDroidkitActorsDispatchAbstractDispatcher *) nil_chk(dispatcher_)) getQueue])) disconnectMailboxWithComDroidkitActorsMailboxMailbox:[scope getMailbox]];
      }
    }
    else {
      DACurrentActor_setCurrentActorWithDAActor_([scope getActor]);
      [scope setSenderWithDAActorRef:[envelope getSender]];
      for (id<ComDroidkitActorsExtensionsActorExtension> __strong e in nil_chk([((DAActor *) nil_chk([scope getActor])) getExtensions])) {
        if ([((id<ComDroidkitActorsExtensionsActorExtension>) nil_chk(e)) onReceiveWithId:[envelope getMessage]]) {
          return;
        }
      }
      [((DAActor *) nil_chk([scope getActor])) onReceiveWithId:[envelope getMessage]];
    }
  }
  @catch (JavaLangException *e) {
    if ([actorSystem_ getTraceInterface] != nil) {
      [((id<ComDroidkitActorsDebugTraceInterface>) nil_chk([actorSystem_ getTraceInterface])) onActorDieWithDAActorRef:[scope getActorRef] withJavaLangException:e];
    }
    [scope onActorDie];
    isDisconnected = YES;
    @synchronized(LOCK_) {
      [((JavaUtilHashMap *) nil_chk(scopes_)) removeWithId:[scope getPath]];
      [((JavaUtilHashMap *) nil_chk(endpoints_)) removeWithId:[scope getPath]];
      [((ComDroidkitActorsMailboxMailboxesQueue *) nil_chk([((ComDroidkitActorsDispatchAbstractDispatcher *) nil_chk(dispatcher_)) getQueue])) disconnectMailboxWithComDroidkitActorsMailboxMailbox:[scope getMailbox]];
    }
  }
  @finally {
    if ([actorSystem_ getTraceInterface] != nil) {
      [((id<ComDroidkitActorsDebugTraceInterface>) nil_chk([actorSystem_ getTraceInterface])) onEnvelopeProcessedWithComDroidkitActorsMailboxEnvelope:envelope withLong:DAActorTime_currentTime() - start];
    }
    DACurrentActor_setCurrentActorWithDAActor_(nil);
    if (!isDisconnected) {
      [((ComDroidkitActorsMailboxMailboxesQueue *) nil_chk([((ComDroidkitActorsDispatchAbstractDispatcher *) nil_chk(dispatcher_)) getQueue])) unlockMailboxWithComDroidkitActorsMailboxMailbox:[envelope getMailbox]];
    }
  }
}

- (void)dealloc {
  RELEASE_(LOCK_);
  RELEASE_(endpoints_);
  RELEASE_(scopes_);
  RELEASE_(actorSystem_);
  RELEASE_(name_);
  RELEASE_(dispatcher_);
  [super dealloc];
}

- (void)copyAllFieldsTo:(ComDroidkitActorsMailboxActorDispatcher *)other {
  [super copyAllFieldsTo:other];
  ComDroidkitActorsMailboxActorDispatcher_set_LOCK_(other, LOCK_);
  ComDroidkitActorsMailboxActorDispatcher_set_endpoints_(other, endpoints_);
  ComDroidkitActorsMailboxActorDispatcher_set_scopes_(other, scopes_);
  ComDroidkitActorsMailboxActorDispatcher_set_actorSystem_(other, actorSystem_);
  ComDroidkitActorsMailboxActorDispatcher_set_name_(other, name_);
  ComDroidkitActorsMailboxActorDispatcher_set_dispatcher_(other, dispatcher_);
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithNSString:withDAActorSystem:", "ActorDispatcher", NULL, 0x1, NULL },
    { "initDispatcherWithComDroidkitActorsDispatchAbstractDispatcher:", "initDispatcher", "V", 0x4, NULL },
    { "referenceActorWithNSString:withDAProps:", "referenceActor", "Lcom.droidkit.actors.ActorRef;", 0x11, NULL },
    { "killGracefullyWithDAActorScope:", "killGracefully", "V", 0x11, NULL },
    { "sendMessageWithComDroidkitActorsMailboxActorEndpoint:withId:withLong:withDAActorRef:", "sendMessage", "V", 0x11, NULL },
    { "sendMessageOnceWithComDroidkitActorsMailboxActorEndpoint:withId:withLong:withDAActorRef:", "sendMessageOnce", "V", 0x11, NULL },
    { "cancelSendWithComDroidkitActorsMailboxActorEndpoint:withId:withDAActorRef:", "cancelSend", "V", 0x11, NULL },
    { "getName", NULL, "Ljava.lang.String;", 0x1, NULL },
    { "processEnvelopeWithComDroidkitActorsMailboxEnvelope:", "processEnvelope", "V", 0x4, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "LOCK_", NULL, 0x12, "Ljava.lang.Object;", NULL,  },
    { "endpoints_", NULL, 0x12, "Ljava.util.HashMap;", NULL,  },
    { "scopes_", NULL, 0x12, "Ljava.util.HashMap;", NULL,  },
    { "actorSystem_", NULL, 0x12, "Lcom.droidkit.actors.ActorSystem;", NULL,  },
    { "name_", NULL, 0x2, "Ljava.lang.String;", NULL,  },
    { "dispatcher_", NULL, 0x2, "Lcom.droidkit.actors.dispatch.AbstractDispatcher;", NULL,  },
  };
  static const J2ObjcClassInfo _ComDroidkitActorsMailboxActorDispatcher = { 1, "ActorDispatcher", "com.droidkit.actors.mailbox", NULL, 0x401, 9, methods, 6, fields, 0, NULL};
  return &_ComDroidkitActorsMailboxActorDispatcher;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ComDroidkitActorsMailboxActorDispatcher)
